services:
  # Nginx Load Balancer
  nginx-load-balancer:
    image: nginx:alpine
    container_name: nginx-load-balancer
    ports:
      - "8080:8080"  # API Gateway
      - "8081:80"    # Product Catalog Load Balancer
      - "8082:81"    # Product Orders Load Balancer
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    networks:
      - spring-cloud-network
    depends_on:
      - product-catalog-1
      - product-catalog-2
      - product-catalog-3
      - product-order-1
      - product-order-2
      - product-order-3
    healthcheck:
      test: ["CMD", "wget", "--quiet", "--tries=1", "--spider", "http://localhost:8080/health"]
      interval: 30s
      timeout: 10s
      retries: 3

  eureka-server:
    # This is a more modern, frequently updated image
    image: steeltoeoss/eureka-server:latest
    container_name: eureka-server
    ports:
      - "8761:8761"
    environment:
      - EUREKA_CLIENT_REGISTER_WITH_EUREKA=false
      - EUREKA_CLIENT_FETCH_REGISTRY=false
    networks:
      - spring-cloud-network

  # Product Catalog Service - Replica 1
  product-catalog-1:
    build:
      context: ./app/Product.Catalog
      dockerfile: Dockerfile
    container_name: product-catalog-1
    ports:
      - "5131:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - Eureka__Client__ServiceUrl=http://eureka-server:8761/eureka/
      - Eureka__Instance__HostName=product-catalog-1
      - Eureka__Instance__Port=8080
      - Eureka__Instance__AppName=product-catalog
    networks:
      - spring-cloud-network
    depends_on:
      - eureka-server

  # Product Catalog Service - Replica 2
  product-catalog-2:
    build:
      context: ./app/Product.Catalog
      dockerfile: Dockerfile
    container_name: product-catalog-2
    ports:
      - "5132:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - Eureka__Client__ServiceUrl=http://eureka-server:8761/eureka/
      - Eureka__Instance__HostName=product-catalog-2
      - Eureka__Instance__Port=8080
      - Eureka__Instance__AppName=product-catalog
    networks:
      - spring-cloud-network
    depends_on:
      - eureka-server

  # Product Catalog Service - Replica 3
  product-catalog-3:
    build:
      context: ./app/Product.Catalog
      dockerfile: Dockerfile
    container_name: product-catalog-3
    ports:
      - "5133:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - Eureka__Client__ServiceUrl=http://eureka-server:8761/eureka/
      - Eureka__Instance__HostName=product-catalog-3
      - Eureka__Instance__Port=8080
      - Eureka__Instance__AppName=product-catalog
    networks:
      - spring-cloud-network
    depends_on:
      - eureka-server

  # Product Order Service - Replica 1
  product-order-1:
    build:
      context: ./app/Product.Order
      dockerfile: Dockerfile
    container_name: product-order-1
    ports:
      - "5141:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - Eureka__Client__ServiceUrl=http://eureka-server:8761/eureka/
      - Eureka__Instance__HostName=product-order-1
      - Eureka__Instance__Port=8080
      - Eureka__Instance__AppName=product-orders
    networks:
      - spring-cloud-network
    depends_on:
      - eureka-server

  # Product Order Service - Replica 2
  product-order-2:
    build:
      context: ./app/Product.Order
      dockerfile: Dockerfile
    container_name: product-order-2
    ports:
      - "5142:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - Eureka__Client__ServiceUrl=http://eureka-server:8761/eureka/
      - Eureka__Instance__HostName=product-order-2
      - Eureka__Instance__Port=8080
      - Eureka__Instance__AppName=product-orders
    networks:
      - spring-cloud-network
    depends_on:
      - eureka-server

  # Product Order Service - Replica 3
  product-order-3:
    build:
      context: ./app/Product.Order
      dockerfile: Dockerfile
    container_name: product-order-3
    ports:
      - "5143:8080"
    environment:
      - ASPNETCORE_ENVIRONMENT=Development
      - ASPNETCORE_URLS=http://+:8080
      - Eureka__Client__ServiceUrl=http://eureka-server:8761/eureka/
      - Eureka__Instance__HostName=product-order-3
      - Eureka__Instance__Port=8080
      - Eureka__Instance__AppName=product-orders
    networks:
      - spring-cloud-network
    depends_on:
      - eureka-server

networks:
  spring-cloud-network:
    driver: bridge